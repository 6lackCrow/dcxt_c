<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" th:href="@{../../static/bootstrap/css/bootstrap-theme.min.css}"/>
    <link rel="stylesheet" th:href="@{../../static/bootstrap/css/bootstrap.min.css}"/>
    <link rel="stylesheet" th:href="@{../../static/css/css-main.css}"/>
    <script type="text/javascript" th:src="@{../../static/jQuery/jquery-3.4.1.min.js}"></script>
    <script type="text/javascript" th:src="@{../../static/bootstrap/js/bootstrap.min.js}"></script>
    <script type="text/javascript" th:src="@{../../static/js/common.js}"></script>
    <style type="text/css">
        #main{
            display: flex;
            flex-direction: row;
        }
        .pull-right{
            display: flex;
            flex-direction: row;
        }
        .none{
            display: none;
        }
        #foodlist{
            display: flex;
            flex-direction: column;
        }
        .disabled{
            pointer-events:none;
        }
    </style>
</head>
<body>
<div class="main-order">
    <div class="main-title"><h2>订单管理</h2></div>
    <div id="main">

        <div class="pull-left form-inline">
            <select id="btn_select" style="width:140px;margin-right:10px;" class="form-control" name="type">
<!--                                /*-->
<!--                                * type=0 显示所有-->
<!--                                * type=1 已付款未发货-->
<!--                                * type=2 已付款-->
<!--                                * type=3 已发货-->
<!--                                * type=4 未付款-->
<!--                                */-->
                <option id="0" value="/admin/order/index?pageNow=1&type=0&search=" > 显示所有</option>
                <option id="1" value="/admin/order/index?pageNow=1&type=1&search=" > 已付款 未发货</option>
                <option id="2" value="/admin/order/index?pageNow=1&type=2&search=" >已付款</option>
                <option id="3" value="/admin/order/index?pageNow=1&type=3&search=" > 已发货</option>
                <option id="4" value="/admin/order/index?pageNow=1&type=4&search=" > 未付款</option>
            </select>
            <script th:inline="javascript">
                var type = [[${type}]];
                console.log(type)
                if (type!=null){
                    $("#"+type).attr("selected", true)
                }
                $('#btn_select').change(function() {
                    var val = $(this).val();
                    if (val) {
                        location.href = val
                    }
                });
            </script>
        </div>


        <form style="width:200px;" action="/admin/order/index">
            <div class="pull-right">
                <input class="none" value="1" name="pageNow">
                <input class="none" value="0" name="type">
                <input type="text" class="form-control" name="search" value="" placeholder="输入取餐码" oninput = "value=value.replace(/[^\d]/g,'')">
                <input type="submit" style="margin-left: 10px" class="btn btn-primary" value="搜索">

            </div>
        </form>
    </div>
    <div class="main-section">
        <table class="table table-striped table-bordered table-hover">
            <thead>
            <tr>
                <th width="100">取餐码</th>
                <th width="120">商品清单</th>
                <th width="110">订单总价</th>
                <th width="130">下单时间</th>
                <th width="130">付款时间</th>
                <th width="130">发货时间</th>
                <th width="130">用户备注</th>
                <th width="130">操作</th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="order:${orders}">
                <td th:text="${order.getId()}"></td>
                <td>
                    <div id="foodlist" th:each="food:${order.getOrder_food()}" style="display:inline-block;line-height: 22px;">
                        <div >
                            <span th:text="${food.getName()}+'*'+${food.getNumber()}"></span>
                            <small style="float:right;color:#888" th:text="'单价 '+${food.getPrice()}+'¥'"></small>
                        </div>
                    </div>
                </td>

                <td>
                    <span></span>
                    <p th:text="${order.getPrice()}"></p><br>
                    <small th:id="'pro'+${order.getId()}"></small>
                    <script th:inline="javascript">
                        var promotion = [[${order.getPromotion()}]]
                        if (promotion != 0) {
                            $("#pro"+[[${order.getId()}]]).text("(已优惠"+promotion + "元)");
                        }
                    </script>
                </td>
                <td><small th:text="${order.getCreate_time()}"></small></td>
                <td th:switch="${order.is_pay}">
                    <small th:case="'1'" th:text="${order.getPay_time()}"></small>
                    <small th:case="'0'" >未支付</small>
                </td>

                <td th:switch="${order.is_taken}">
                    <small th:case="1" th:text="${order.getTaken_time()}"></small>
                    <small th:case="0">未发货</small>
                </td>
                <td th:text="${order.getComment()}"></td>
                <td>
                    <a th:id="${'op'+order.getId()}" class="js-taken" style="color:#F06C00;font-weight:600" href=""></a>
                    <script th:inline="javascript">
                        var is_pay = [[${order.getIs_pay()}]]
                        var is_taken = [[${order.getIs_taken()}]]
                        var id = [[${order.getId()}]]
                        var type = [[${type}]]
                        var search = [[${search}]]
                        var pageNow = [[${pageNow}]]
                        console.log("type:"+type+" search="+search+" pageNow="+pageNow)
                        if(is_pay==0){
                            $('#op'+ id).text('删除').attr('href','/admin/order/deletefood?id='+id+'&type='+type+'&search='+search+'&pageNow='+pageNow)
                        }
                        else if(is_pay==1&&is_taken==0){
                            //可以执行发货操作
                            $('#op' + id).text('发货').attr('href','/admin/order/sendoutgoods?id='+id+'&type='+type+'&search='+search+'&pageNow='+pageNow)
                        }
                        else if(is_pay==1&&is_taken==1){
                            //可以执行取消发货操作
                            $('#op' + id).text('取消').attr('href','/admin/order/cancelshipment?id='+id+'&type='+type+'&search='+search+'&pageNow='+pageNow)
                        }
                    </script>
                </td>

            </tr>
            </tbody>
        </table>
    </div>
    <div class="main-section">
        <ul class="pagination">
            <li id="back"><a th:href="@{'/admin/order/index?search='+${search}+'&type='+${type}+'&pageNow=' + ${pageBack}}">«</a></li>
            <li th:each="page:${pageList}" th:id="'page'+${page}"><a th:href="@{'/admin/order/index?search='+${search}+'&type='+${type}+'&pageNow=' + ${page}}" th:text="${page}"></a></li>
            <li id="next" ><a th:href="@{'/admin/order/index?search='+${search}+'&type='+${type}+'&pageNow=' + ${pageNext}}">»</a></li>
        </ul>
        <script th:inline="javascript">
            var idNow = [[${pageNow}]];
            var idmax = [[${pageMax}]]
            if (idNow==1){
                $("#back").addClass("disabled");
            }
            if (idmax == idNow){
                $("#next").addClass("disabled");
            }
            $("#page"+idNow).addClass("active")
        </script>
    </div>
</div>
</body>
</html>